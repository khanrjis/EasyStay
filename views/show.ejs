<% layout("/layout/boilerplate") %>

<div class="container mt-4">

  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">

      <!-- Title -->
      <h3 class="mb-3"><%= listing.title %></h3>

      <!-- Listing Card -->
      <div class="card listing-card shadow-sm p-3">

        <!-- Image -->
        <img src="<%= listing.image %>" 
             class="card-img-top mb-3 rounded" 
             alt="<%= listing.title %>">

        <div class="card-body">

          <!-- Owner -->
          <p class="mb-2">
            <strong>Hosted by:</strong> 
            <%= listing.owner.username %>
          </p>

          <!-- Description -->
          <p class="mb-2">
            <strong>Description:</strong><br>
            <%= listing.description %>
          </p>

          <!-- Price -->
          <p class="mb-1">
            <strong>Price:</strong> ₹<%= listing.price %> 
            <span class="text-muted">/ night</span>
          </p>

          <!-- Location -->
          <p class="mb-1">
            <strong>Location:</strong> <%= listing.location %>
          </p>

          <!-- Country -->
          <p class="mb-3">
            <strong>Country:</strong> <%= listing.country %>
          </p>

          <!-- Buttons -->
<% if (currUser && currUser._id.equals(listing.owner.id)) { %>
  <div class="d-flex gap-2">
    <a href="/listings" class="btn btn-outline-dark">Back</a>

    <a href="/listings/<%= listing._id %>/edit" 
       class="btn btn-dark">
      Edit
    </a>

    <form action="/listings/<%= listing._id %>?_method=DELETE" 
          method="POST"
          onsubmit="return confirm('Are you sure you want to delete this listing?')">

      <button type="submit" class="btn btn-danger">
        Delete
      </button>
    </form>
  </div>
<% } %>

        </div>
      </div>

      <!-- Review Form -->
      <div class="card mt-4 shadow-sm">
        <div class="card-body">
        
          <h4 class="mb-3">Leave a Review</h4>

          <form action="/listings/<%= listing._id %>/reviews" 
                method="POST" 
                class="needs-validation" 
                novalidate>

            <!-- Rating -->
            <div class="mb-3">
              <label for="rating" class="form-label">Rating</label>

              <input type="range" 
                     min="1" 
                     max="5" 
                     id="rating" 
                     name="review[rating]" 
                     class="form-range" 
                     required>

              <div class="d-flex justify-content-between text-muted small">
                <span>1</span>
                <span>5</span>
              </div>

              <div class="invalid-feedback">
                Please select a rating.
              </div>
            </div>

            <!-- Comment -->
            <div class="mb-3">
              <label for="comment" class="form-label">Comment</label>

              <textarea id="comment" 
                        name="review[comment]" 
                        rows="4" 
                        class="form-control"
                        placeholder="Share your experience..." 
                        required></textarea>

              <div class="invalid-feedback">
                Comment is required.
              </div>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-primary">
              Submit Review
            </button>

          </form>

        </div>
      </div>

      <!-- Guest Reviews -->
      <div class="mt-5">
        <h4 class="mb-3">Guest Reviews</h4>

        <% if (listing.reviews.length === 0) { %>

          <p class="text-muted fst-italic">
            No reviews yet. Be the first to share your experience!
          </p>

        <% } else { %>

          <div class="list-group">

            <% listing.reviews.forEach(function(review){ %>

              <div class="list-group-item mb-3 rounded shadow-sm">

                <!-- Rating & Date -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>⭐ <%= review.rating %> / 5</strong>
                  <small class="text-muted">
                    <%= new Date(review.createdAt).toLocaleDateString() %>
                  </small>
                </div>

                <!-- Comment -->
                <p class="mb-2 text-secondary">
                  <%= review.comment %>
                </p>

                <!-- Delete Review -->
                <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
                      method="POST"
                      onsubmit="return confirm('Are you sure you want to delete this review?');">

                  <button type="submit" 
                          class="btn btn-sm btn-outline-danger">
                    Delete Review
                  </button>
                </form>

              </div>

            <% }) %>

          </div>

        <% } %>

      </div>

    </div>
  </div>

</div>
